{% extends 'app/base_app.html' %}
{% block title %} Inicio {% endblock %}

{%  block content %}

 <h1 class="mt-4">Nueva compra</h1> 

 <div id="alert-form"></div>

 <div class="container">
    
    <form class="form" method="POST"  id="formulario_registro_compra" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row">
        <div class="col-md-4 col-sm-4 col-lg-4">
          {{ form.fecha.label }}
          <br>
          {{ form.fecha }}
        </div>
      </div>

      {{ detalle_compra_formset.management_form }}
      
        <div id="form_set">
        {% for form in detalle_compra_formset %}
        <table class="table table-striped table-bordered" onkeyup='calcularMult()'>
        <br>
          <thead>
            <tr>
              <th>{{ form.producto_id.label }}</th>
              <th>{{ form.proveedor_id.label }}</th>
              <th>{{ form.cantidad.label }}</th>
              <th>{{ form.valor_unitario.label }}</th>
              <th>{{ form.total_producto.label }}</th>
            </tr>          
          </thead>
          <tbody>
            <tr>
              <td>{{ form.producto_id }}</td>
              <td>{{ form.proveedor_id }}</td>
              <td>{{ form.cantidad }}</td>
              <td>{{ form.valor_unitario }}</td>
              <td>{{ form.total_producto }}</td>
            </tr>
          </tbody>
        </table>
        {% endfor %}
        </div>
      
      
        <div id="empty_form" style="display:none">
          <table class="table table-striped table-bordered" onkeyup='calcularMult()'>
            <tbody>
              <tr>
                <td>{{ detalle_compra_formset.empty_form.producto_id }}</td>
                <td>{{ detalle_compra_formset.empty_form.proveedor_id }}</td>
                <td>{{ detalle_compra_formset.empty_form.cantidad }}</td>
                <td>{{ detalle_compra_formset.empty_form.valor_unitario }}</td>
                <td>{{ detalle_compra_formset.empty_form.total_producto }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <input type="hidden" value="1" name="additems" id="additems">
        <input type="button" id="additemsbutton" value="+" class="btn btn-success btn-lg">
  
      <div class="row">
        <div class="col-md-4 col-sm-4 col-lg-4 p-2">
          {{ form.subtotal_neto.label }}
          {{ form.subtotal_neto }}
        </div>
        <div class="col-md-4 col-sm-4 col-lg-4 p-2">
          {{ form.IVA.label }}
          {{ form.IVA }}
        </div>
        <div class="col-md-4 col-sm-4 col-lg-4 p-2">
          {{ form.total.label }}
          {{ form.total }}
        </div>
      </div>

      <br>
      <button class="save btn btn-primary" type="submit">Guardar</button>
      <br><br>
    </form>    

  </div>

 {% endblock %} 

  {% block javascript %}
<script type='text/javascript'>
  var form_num = 0;
  $(document).ready(function() {
      $("#additemsbutton").on('click',function(event)
      {
        ++form_num;
        $('#form_set').append(
          $('#empty_form').html().replace(/__prefix__/g, form_num)
          );
        $('#id_detalle_compra_set-TOTAL_FORMS').val(form_num + 1);
        $("#additems").val(form_num + 1);
     });
  });

  function calcularMult(){
    var idx = $("#additems").val();
    console.log(idx);
    var sum = 0;
    for (var i = 0; i <= idx; i++) {
        $("#id_detalle_compra_set-" + i + "-total_producto").val($("#id_detalle_compra_set-" + i + "-cantidad").val() * $("#id_detalle_compra_set-" + i + "-valor_unitario").val());
        $("input[id^='id_detalle_compra_set-"+ i + "-total_producto']").each(function() {
          sum += Number($(this).val());
         });
    };       
    $("#id_subtotal_neto").val(sum);
    var bla = parseInt($("#id_subtotal_neto").val() / (1.19));
    console.log(bla);
    $("#id_IVA").val($("#id_subtotal_neto").val() - bla );
    $("#id_total").val(parseInt($("#id_subtotal_neto").val()) + parseInt($("#id_IVA").val()) ).val();

  };

</script>
 {% endblock %} 

