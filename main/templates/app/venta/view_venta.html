{% extends 'app/base_app.html' %}
{% block title %} Inicio {% endblock %}

{%  block content %}

 <h1 class="mt-4">Lista Ventas</h1>

 <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Fecha de ventas realizadas</th>
        <th>Total</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="respuesta_j">

    </tbody>
  </table>

<!-- Modal Edliminar -->
  <div class="modal fade" id="eliminarmodal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Eliminar venta</h4>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">

              <div id="id_p2" hidden="false"></div>
              <p id="mensaje2"></p>
              <button class="save btn btn-danger" type="submit" onclick="Eliminar()">Eliminar</button> <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>

            </div>

      </div>
    </div>
  </div>


 {% endblock %}

{% block javascript %}
<script type="text/javascript">

$(document).ready(function() {
    id = $('#usuario_id').text();
    // console.log(id);
    var csrftoken = '{{ csrf_token }}';
    $.ajax({
      headers: {'X-CSRF-TOKEN': csrftoken},
      method: "GET",
      url: '/ventas/lista/'+id+'/',
      dataType: 'json',
      data: { "csrfmiddlewaretoken": csrftoken,
          "id": id }
    })

    .done(function(response){
      // console.log(response);
      var res = response;
      var html = '';
      var url = "{% url 'detalles_ventas' ";
      if (JSON.stringify(res)=='{}'){
        html = '<tr><td colspan="6" class="text-center bg-warning">No hay ventas registrados</td></tr>'
      }
      else{
        for(var item in res){
          // console.log(res[item]);
          html +='<tr>';
          html +='<td>'+res[item].fecha+'</td>';
          html +='<td>'+res[item].total+'</td>';
          html +='<td><a class="btn btn-success btn-sm" href="/ventas/lista/detalle/'+res[item].id_venta+'/"> Detalles </a> ';
          html +=' <a class="btn btn-danger btn-sm"  data-toggle="modal" data-target="#eliminarmodal" onclick="datos2('+res[item].id_venta+')">Borrar </a></td>';
          html +='</tr>';
        }
      }

      $("#respuesta_j").html(html)

    })
});

function datos2(id) {
    console.log(id);
    var csrftoken = '{{ csrf_token }}';
    $.ajax({
      headers: {'X-CSRF-TOKEN': csrftoken},
      method: "GET",
      url: '/ventas/eliminar/'+id+'/',
      dataType: 'json',
      data: { "csrfmiddlewaretoken": csrftoken,
          "id": id }
    })

    .done(function(response){
      // console.log(response);
      var res = response;

      $('#id_p2').text(res.idd);
      $('#mensaje2').html('¿ Está seguro que desea eliminar la venta de valor <b>' + res.total + '</b> con fecha del <b>'+ res.fecha +'</b> ?');

    })
}

function Eliminar() {
    var id2 = $("#id_p2").text();
    console.log(id2);
    var csrftoken = '{{ csrf_token }}';
    $.ajax({
      headers: {'X-CSRF-TOKEN': csrftoken},
      method: "POST",
      url: '/ventas/eliminar/'+id2+'/',
      dataType: 'text',
      data: { "csrfmiddlewaretoken": csrftoken,
          "id": id2 },
      success:function(data){
          alert('Se eliminó con éxito');
          location.reload();
      },
      error: function(xhr, e, x, status) {
        console.log(xhr.status + " -- " + status + " -- " + e + " -- " + x);
        alert('Ha ocurrido un error, porfavor vuelva a intentar');
      }
    })
 }
</script>
{% endblock %}
