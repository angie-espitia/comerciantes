{% extends 'app/base_app.html' %}
{% block title %} Inicio {% endblock %}

{%  block content %}

 <h1 class="mt-4">Lista de proveedores</h1>

 <table class="table table-striped table-bordered">

 	<br>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Razón social</th>
        <th>teléfono</th>
        <th>dirección</th>
        <th>celular</th>
        <th>email</th>
        <th>Acciones</th>
      </tr>
    </thead>
    {% for row in usuario_proveedor %}
    <tbody>
      <tr>
        <td>{{ row.proveedor_id.nombre }}</td>
        <td>{{ row.proveedor_id.razon_social }}</td>
        <td>{{ row.proveedor_id.telefono }}</td>
        <td>{{ row.proveedor_id.direccion }}</td>
        <td>{{ row.proveedor_id.celular }}</td>
        <td>{{ row.proveedor_id.email }}</td>
        <td>
          <a id="{{row.proveedor_id.id}}" class="btn btn-primary" data-toggle="modal" data-target="#editarmodal" onclick="datos(this.id)"> Editar </a> 
          <a id="{{row.proveedor_id.id}}" class="btn btn-danger" data-toggle="modal" data-target="#eliminarmodal" onclick="datos2(this.id)">Borrar</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center bg-warning">No hay proveedores registrados</td>
      </tr>
    </tbody>
    {% endfor %}
  </table>

  <!-- Modal Editar -->
  <div class="modal fade" id="editarmodal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Editar Proveedor</h4>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">

              <form class="form" method="POST" id="formulario_editar_proveedor">
                {% csrf_token %}
                
                <div class="form-group">
                  <input id="id_p" hidden="false">
                  <label>Nombre de contácto:</label>
                  <input type="text" class="form-control" id="nombre_p">
                  <div id="errornombre"></div>
                </div>

                <div class="form-group">
                  <label>razon social:</label>
                  <input type="text" class="form-control" id="razon_social_p" required>
                </div>

                <div class="form-group">
                  <label>direccion:</label>
                  <input type="text" class="form-control" id="direccion_p">
                </div>

                <div class="form-group">
                  <label>email:</label>
                  <input type="text" class="form-control" id="email_p">
                  <div id="erroremail"></div>
                </div>

                <div class="form-group">
                  <label>telefono:</label>
                  <input type="text" class="form-control" id="telefono_p">
                  <div id="errortelefono"></div>
                </div>

                <div class="form-group">
                  <label>celular:</label>
                  <input type="text" class="form-control" id="celular_p">
                  <div id="errorcelular"></div>
                </div>


                  <button class="save btn btn-primary" type="submit" onclick="Actualizar()">Guardar</button>
                  <br><br>
              </form>

            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>

      </div>
    </div>
  </div>

  <!-- Modal Editar -->
  <div class="modal fade" id="eliminarmodal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Eliminar Proveedor</h4>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">

              <div id="id_p2" hidden="false"></div>
              <p id="mensaje2"></p>
              <button class="save btn btn-danger" type="submit" onclick="Eliminar()">Eliminar</button> <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>

            </div>

      </div>
    </div>
  </div>

 {% endblock %}

 {% block javascript %}
 <script>
 function datos(id) {

        console.log(id);
        var csrftoken = '{{ csrf_token }}';
        $.ajax({
          headers: {'X-CSRF-TOKEN': csrftoken},
          method: "GET",
          url: '/proveedores/editar/'+id+'/',
          dataType: 'json',
          data: { "csrfmiddlewaretoken": csrftoken,
              "id": id }
        })

        .done(function(response){
          console.log(response);
          var res = response;
          
          $('#id_p').val(res.id);
          $('#nombre_p').val(res.nombre);
          $('#razon_social_p').val(res.razon_social);
          $('#direccion_p').val(res.direccion);
          $('#email_p').val(res.email);
          $('#telefono_p').val(res.telefono);
          $('#celular_p').val(res.celular);
          
        });
      }

function Actualizar() {

    var id = $("#id_p").val();
    var nombre = $("#nombre_p").val();
    var razon = $("#razon_social_p").val();
    var direccion = $("#direccion_p").val();
    var telefono = $("#telefono_p").val();
    var email = $("#email_p").val();
    var celular = $("#celular_p").val();
    var csrftoken = '{{ csrf_token }}';

    validacion_nombre = /^([A-Za-zñÑáéíóúÁÉÍÓÚ\s])*$/;
    validacion_numeros = /^([0-9])*$/;
    validacion_email = /^[a-zA-Z0-9_\.\-]+@[a-zA-Z0-9\-]+\.[a-zA-Z0-9\-\.]+$/;

    if (!validacion_nombre.test(nombre)){
      $('#nombre_p').focus();
      $('#errornombre').html('<small class="form-text text-muted">Ingrese un nombre válido</small>');
      return false;
    } else if (!validacion_email.test(email)){
      $('#errornombre').html('');
      $('#email_p').focus();
      $('#erroremail').html('<small class="form-text text-muted">Ingrese una dirección de correo válida.</small>');
      return false;
    } else if (!validacion_numeros.test(telefono)){
      $('#errornombre').html('');
      $('#erroremail').html('');
      $('#telefono_p').focus();
      $('#errortelefono').html('<small class="form-text text-muted">Ingrese un número de teléfono válido sin dejar espacios.</small>');
      return false;
    } else if (!validacion_numeros.test(celular)){
      $('#errornombre').html('');
      $('#erroremail').html('');
      $('#errortelefono').html('');
      $('#celular_p').focus();
      $('#errorcelular').html('<small class="form-text text-muted">Ingrese un número de celular válido sin dejar espacios.</small>');
      return false;
    } else {

      $.ajax({
        headers: {'X-CSRF-TOKEN': csrftoken},
        method: 'POST',
        url: '/proveedores/editar/'+id+'/',
        dataType: 'text',
        data: { 'csrfmiddlewaretoken': csrftoken ,
          'nombre_proveedor': nombre,
          'razon_social_proveedor': razon,
          'direccion_proveedor': direccion,
          'celular_proveedor': celular,
          'telefono_proveedor': telefono,
          'email_proveedor':email },
          success:function(data){
              // alert('Se ha actualizado con éxito');
          },
          error: function(xhr, e, x, status) {
            console.log(xhr.status + " -- " + status + " -- " + e + " -- " + x);
            alert('Ha ocurrido un error, porfavor vuelva a intentar');
          }     
        
      });
    }
}

function datos2(id) {
    console.log(id);
    var csrftoken = '{{ csrf_token }}';
    $.ajax({
      headers: {'X-CSRF-TOKEN': csrftoken},
      method: "GET",
      url: '/proveedores/eliminar/'+id+'/',
      dataType: 'json',
      data: { "csrfmiddlewaretoken": csrftoken,
          "id": id }
    })

    .done(function(response){
      console.log(response);
      var res = response;
      
      $('#id_p2').text(res.id);
      $('#mensaje2').text('¿Está seguro que desea eliminar al proveedor ' + res.razon_social + ' ?');
      
    });
}

function Eliminar() {
    var id2 = $("#id_p2").text();
    console.log(id2);
    var csrftoken = '{{ csrf_token }}';
    $.ajax({
      headers: {'X-CSRF-TOKEN': csrftoken},
      method: "POST",
      url: '/proveedores/eliminar/'+id2+'/',
      dataType: 'text',
      data: { "csrfmiddlewaretoken": csrftoken,
          "id": id2 },
      success:function(data){
          alert('Se eliminó con éxito');
          location.reload();
      },
      error: function(xhr, e, x, status) {
        console.log(xhr.status + " -- " + status + " -- " + e + " -- " + x);
        alert('Ha ocurrido un error, porfavor vuelva a intentar');
      } 
    })
    // .done(function(response){
    //   var res = response;
    //   console.log(res);
    //   alert('Se eliminó con éxito');   
      
    // });
}
</script>
 {% endblock %} 